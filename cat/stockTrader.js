import { STOCK_MARKET_COMMISSION_FEE } from "/libs/constants";
import { NetscriptExtension } from "/libs/NetscriptExtension";
const defaultConfig = {
  reservedMoney: 1e6,
  buyLongThreshold: 0.6,
  sellLongThreshold: 0.55,
  buyShortThreshold: 0.4,
  sellShortThreshold: 0.45,
  enableShort: false
};
let customConfig = null;
customConfig = {
  reservedMoney: 1e6,
  buyLongThreshold: 0.55,
  sellLongThreshold: 0.53,
  buyShortThreshold: defaultConfig.buyShortThreshold,
  sellShortThreshold: defaultConfig.sellShortThreshold,
  enableShort: true
};
function printStockData(ns) {
  const stockStats = nsx.calculateStockStats();
  ns.print(`Current profit: ${ns.formatNumber(stockStats.currentProfit)}`);
  ns.print(`Estimated total profit: ${ns.formatNumber(stockStats.estimatedTotalProfit)}`);
  ns.print(`Current worth: ${ns.formatNumber(stockStats.currentWorth)}`);
}
async function tradeStocksWithS4MarketData(ns, config) {
  while (true) {
    const stockSymbols = ns.stock.getSymbols().sort(function(a, b) {
      return Math.abs(0.5 - ns.stock.getForecast(b)) - Math.abs(0.5 - ns.stock.getForecast(a));
    });
    for (const stockSymbol of stockSymbols) {
      let availableMoney = ns.getPlayer().money - config.reservedMoney;
      if (availableMoney <= 0) {
        break;
      }
      const position = ns.stock.getPosition(stockSymbol);
      const sharesLong = position[0];
      const forecast = ns.stock.getForecast(stockSymbol);
      if (forecast < config.sellLongThreshold && sharesLong > 0) {
        ns.stock.sellStock(stockSymbol, sharesLong);
        availableMoney = ns.getPlayer().money - config.reservedMoney;
      }
      if (forecast > config.buyLongThreshold) {
        const maxSharesForBuying = ns.stock.getMaxShares(stockSymbol) - sharesLong;
        const askPrice = ns.stock.getAskPrice(stockSymbol);
        const affordableShares = Math.floor(
          (availableMoney - STOCK_MARKET_COMMISSION_FEE) / askPrice
        );
        const shares = Math.min(affordableShares, maxSharesForBuying);
        if (shares <= 0) {
          continue;
        }
        ns.stock.buyStock(stockSymbol, shares);
        availableMoney = ns.getPlayer().money - config.reservedMoney;
      }
    }
    ns.clearLog();
    printStockData(ns);
    await ns.sleep(2e3);
  }
}
async function tradeStocksWithoutS4MarketData(ns, config) {
  function getForecast(priceChanges) {
    const numberOfTimesPriceIncreased = priceChanges.reduce((accumulator, currentValue) => {
      return accumulator + (currentValue > 1 ? 1 : 0);
    }, 0);
    return numberOfTimesPriceIncreased / priceChanges.length;
  }
  const stockPrices = /* @__PURE__ */ new Map();
  const stockPriceChanges = /* @__PURE__ */ new Map();
  let stockSymbols = ns.stock.getSymbols();
  stockSymbols.forEach((symbol) => {
    stockPrices.set(symbol, [ns.stock.getPrice(symbol)]);
    stockPriceChanges.set(symbol, []);
  });
  while (true) {
    const numberOfSamples = 15;
    const isPriceChanged = stockSymbols.some((symbol) => {
      const symbolPrices = stockPrices.get(symbol);
      return symbolPrices[symbolPrices.length - 1] !== ns.stock.getPrice(symbol);
    });
    if (!isPriceChanged) {
      ns.clearLog();
      printStockData(ns);
      await ns.sleep(1e3);
      continue;
    }
    const haveEnoughSamples = stockSymbols.every((symbol) => {
      return stockPriceChanges.get(symbol).length > numberOfSamples;
    });
    stockSymbols.forEach((symbol) => {
      const symbolPrices = stockPrices.get(symbol);
      const symbolPriceChanges = stockPriceChanges.get(symbol);
      symbolPrices.push(ns.stock.getPrice(symbol));
      if (symbolPrices.length > 1) {
        symbolPriceChanges.push(symbolPrices[symbolPrices.length - 1] / symbolPrices[symbolPrices.length - 2]);
      }
      if (haveEnoughSamples) {
        symbolPrices.shift();
        symbolPriceChanges.shift();
      }
    });
    if (!haveEnoughSamples) {
      ns.clearLog();
      printStockData(ns);
      await ns.sleep(1e3);
      continue;
    }
    stockSymbols = stockSymbols.sort(function(a, b) {
      return Math.abs(0.5 - getForecast(stockPriceChanges.get(b))) - Math.abs(0.5 - getForecast(stockPriceChanges.get(a)));
    });
    for (const stockSymbol of stockSymbols) {
      let availableMoney = ns.getPlayer().money - config.reservedMoney;
      if (availableMoney <= 0) {
        break;
      }
      const position = ns.stock.getPosition(stockSymbol);
      const sharesLong = position[0];
      const sharesShort = position[2];
      const forecast = getForecast(stockPriceChanges.get(stockSymbol));
      if (forecast < 0.4 && sharesLong > 0) {
        ns.stock.sellStock(stockSymbol, sharesLong);
        availableMoney = ns.getPlayer().money - config.reservedMoney;
      }
      if (forecast > 0.5 && sharesShort > 0 && config.enableShort) {
        ns.stock.sellShort(stockSymbol, sharesShort);
        availableMoney = ns.getPlayer().money - config.reservedMoney;
      }
      if (forecast > 0.7) {
        const maxSharesForBuying = ns.stock.getMaxShares(stockSymbol) - sharesLong;
        const askPrice = ns.stock.getAskPrice(stockSymbol);
        const affordableShares = Math.floor(
          (availableMoney - STOCK_MARKET_COMMISSION_FEE) / askPrice
        );
        const shares = Math.min(affordableShares, maxSharesForBuying);
        if (shares <= 0) {
          continue;
        }
        ns.stock.buyStock(stockSymbol, shares);
        availableMoney = ns.getPlayer().money - config.reservedMoney;
      }
      if (forecast < 0.3 && config.enableShort) {
        const maxSharesForBuying = ns.stock.getMaxShares(stockSymbol) - sharesShort;
        const bidPrice = ns.stock.getBidPrice(stockSymbol);
        const affordableShares = Math.floor(
          (availableMoney - STOCK_MARKET_COMMISSION_FEE) / bidPrice
        );
        const shares = Math.min(affordableShares, maxSharesForBuying);
        if (shares <= 0) {
          continue;
        }
        ns.stock.buyShort(stockSymbol, shares);
      }
    }
    ns.clearLog();
    printStockData(ns);
    await ns.sleep(1e3);
  }
}
let nsx;
async function main(ns) {
  nsx = new NetscriptExtension(ns);
  nsx.killProcessesSpawnFromSameScript();
  const config = customConfig !== null ? customConfig : defaultConfig;
  ns.disableLog("ALL");
  if (!ns.stock.hasWSEAccount()) {
    ns.tprint("Please buy WSE account");
    return;
  }
  if (!ns.stock.hasTIXAPIAccess()) {
    ns.tprint("Please buy TIX API access");
    return;
  }
  if (ns.stock.has4SDataTIXAPI()) {
    await tradeStocksWithS4MarketData(ns, config);
  } else {
    await tradeStocksWithoutS4MarketData(ns, config);
  }
}
export {
  main
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vc3JjL3N0b2NrVHJhZGVyLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyJpbXBvcnQge05TfSBmcm9tIFwiQG5zXCI7XHJcbmltcG9ydCB7U1RPQ0tfTUFSS0VUX0NPTU1JU1NJT05fRkVFfSBmcm9tIFwiL2xpYnMvY29uc3RhbnRzXCI7XHJcbmltcG9ydCB7TmV0c2NyaXB0RXh0ZW5zaW9ufSBmcm9tIFwiL2xpYnMvTmV0c2NyaXB0RXh0ZW5zaW9uXCI7XHJcblxyXG5pbnRlcmZhY2UgQ29uZmlnIHtcclxuICAgIHJlc2VydmVkTW9uZXk6IG51bWJlcjtcclxuICAgIGJ1eUxvbmdUaHJlc2hvbGQ6IG51bWJlcjtcclxuICAgIHNlbGxMb25nVGhyZXNob2xkOiBudW1iZXI7XHJcbiAgICBidXlTaG9ydFRocmVzaG9sZDogbnVtYmVyO1xyXG4gICAgc2VsbFNob3J0VGhyZXNob2xkOiBudW1iZXI7XHJcbiAgICBlbmFibGVTaG9ydDogYm9vbGVhbjtcclxufVxyXG5cclxuY29uc3QgZGVmYXVsdENvbmZpZzogQ29uZmlnID0ge1xyXG4gICAgcmVzZXJ2ZWRNb25leTogMWU2LFxyXG4gICAgYnV5TG9uZ1RocmVzaG9sZDogMC42LFxyXG4gICAgc2VsbExvbmdUaHJlc2hvbGQ6IDAuNTUsXHJcbiAgICBidXlTaG9ydFRocmVzaG9sZDogMC40LFxyXG4gICAgc2VsbFNob3J0VGhyZXNob2xkOiAwLjQ1LFxyXG4gICAgZW5hYmxlU2hvcnQ6IGZhbHNlLFxyXG59O1xyXG5cclxubGV0IGN1c3RvbUNvbmZpZzogQ29uZmlnIHwgbnVsbCA9IG51bGw7XHJcbmN1c3RvbUNvbmZpZyA9IDxDb25maWc+e1xyXG4gICAgcmVzZXJ2ZWRNb25leTogMWU2LFxyXG4gICAgYnV5TG9uZ1RocmVzaG9sZDogMC41NSxcclxuICAgIHNlbGxMb25nVGhyZXNob2xkOiAwLjUzLFxyXG4gICAgYnV5U2hvcnRUaHJlc2hvbGQ6IGRlZmF1bHRDb25maWcuYnV5U2hvcnRUaHJlc2hvbGQsXHJcbiAgICBzZWxsU2hvcnRUaHJlc2hvbGQ6IGRlZmF1bHRDb25maWcuc2VsbFNob3J0VGhyZXNob2xkLFxyXG4gICAgZW5hYmxlU2hvcnQ6IHRydWUsXHJcbn07XHJcblxyXG5mdW5jdGlvbiBwcmludFN0b2NrRGF0YShuczogTlMpIHtcclxuICAgIGNvbnN0IHN0b2NrU3RhdHMgPSBuc3guY2FsY3VsYXRlU3RvY2tTdGF0cygpO1xyXG4gICAgbnMucHJpbnQoYEN1cnJlbnQgcHJvZml0OiAke25zLmZvcm1hdE51bWJlcihzdG9ja1N0YXRzLmN1cnJlbnRQcm9maXQpfWApO1xyXG4gICAgbnMucHJpbnQoYEVzdGltYXRlZCB0b3RhbCBwcm9maXQ6ICR7bnMuZm9ybWF0TnVtYmVyKHN0b2NrU3RhdHMuZXN0aW1hdGVkVG90YWxQcm9maXQpfWApO1xyXG4gICAgbnMucHJpbnQoYEN1cnJlbnQgd29ydGg6ICR7bnMuZm9ybWF0TnVtYmVyKHN0b2NrU3RhdHMuY3VycmVudFdvcnRoKX1gKTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gdHJhZGVTdG9ja3NXaXRoUzRNYXJrZXREYXRhKG5zOiBOUywgY29uZmlnOiBDb25maWcpIHtcclxuICAgIHdoaWxlICh0cnVlKSB7XHJcbiAgICAgICAgY29uc3Qgc3RvY2tTeW1ib2xzID0gbnMuc3RvY2suZ2V0U3ltYm9scygpXHJcbiAgICAgICAgICAgIC5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5hYnMoMC41IC0gbnMuc3RvY2suZ2V0Rm9yZWNhc3QoYikpIC0gTWF0aC5hYnMoMC41IC0gbnMuc3RvY2suZ2V0Rm9yZWNhc3QoYSkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICBmb3IgKGNvbnN0IHN0b2NrU3ltYm9sIG9mIHN0b2NrU3ltYm9scykge1xyXG4gICAgICAgICAgICBsZXQgYXZhaWxhYmxlTW9uZXkgPSBucy5nZXRQbGF5ZXIoKS5tb25leSAtIGNvbmZpZy5yZXNlcnZlZE1vbmV5O1xyXG4gICAgICAgICAgICBpZiAoYXZhaWxhYmxlTW9uZXkgPD0gMCkge1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBucy5zdG9jay5nZXRQb3NpdGlvbihzdG9ja1N5bWJvbCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNoYXJlc0xvbmcgPSBwb3NpdGlvblswXTtcclxuICAgICAgICAgICAgY29uc3QgZm9yZWNhc3QgPSBucy5zdG9jay5nZXRGb3JlY2FzdChzdG9ja1N5bWJvbCk7XHJcblxyXG4gICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSB3YW50IHRvIHNlbGwgbG9uZ1xyXG4gICAgICAgICAgICBpZiAoZm9yZWNhc3QgPCBjb25maWcuc2VsbExvbmdUaHJlc2hvbGQgJiYgc2hhcmVzTG9uZyA+IDApIHtcclxuICAgICAgICAgICAgICAgIG5zLnN0b2NrLnNlbGxTdG9jayhzdG9ja1N5bWJvbCwgc2hhcmVzTG9uZyk7XHJcbiAgICAgICAgICAgICAgICBhdmFpbGFibGVNb25leSA9IG5zLmdldFBsYXllcigpLm1vbmV5IC0gY29uZmlnLnJlc2VydmVkTW9uZXk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIENoZWNrIGlmIHdlIHdhbnQgdG8gYnV5IGxvbmdcclxuICAgICAgICAgICAgaWYgKGZvcmVjYXN0ID4gY29uZmlnLmJ1eUxvbmdUaHJlc2hvbGQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1heFNoYXJlc0ZvckJ1eWluZyA9IG5zLnN0b2NrLmdldE1heFNoYXJlcyhzdG9ja1N5bWJvbCkgLSBzaGFyZXNMb25nO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXNrUHJpY2UgPSBucy5zdG9jay5nZXRBc2tQcmljZShzdG9ja1N5bWJvbCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhZmZvcmRhYmxlU2hhcmVzID0gTWF0aC5mbG9vcihcclxuICAgICAgICAgICAgICAgICAgICAoYXZhaWxhYmxlTW9uZXkgLSBTVE9DS19NQVJLRVRfQ09NTUlTU0lPTl9GRUUpIC8gYXNrUHJpY2VcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZXMgPSBNYXRoLm1pbihhZmZvcmRhYmxlU2hhcmVzLCBtYXhTaGFyZXNGb3JCdXlpbmcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNoYXJlcyA8PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBucy5zdG9jay5idXlTdG9jayhzdG9ja1N5bWJvbCwgc2hhcmVzKTtcclxuICAgICAgICAgICAgICAgIGF2YWlsYWJsZU1vbmV5ID0gbnMuZ2V0UGxheWVyKCkubW9uZXkgLSBjb25maWcucmVzZXJ2ZWRNb25leTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBucy5jbGVhckxvZygpO1xyXG4gICAgICAgIHByaW50U3RvY2tEYXRhKG5zKTtcclxuICAgICAgICBhd2FpdCBucy5zbGVlcCgyMDAwKTtcclxuICAgIH1cclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gdHJhZGVTdG9ja3NXaXRob3V0UzRNYXJrZXREYXRhKG5zOiBOUywgY29uZmlnOiBDb25maWcpIHtcclxuICAgIGZ1bmN0aW9uIGdldEZvcmVjYXN0KHByaWNlQ2hhbmdlczogbnVtYmVyW10pIHtcclxuICAgICAgICBjb25zdCBudW1iZXJPZlRpbWVzUHJpY2VJbmNyZWFzZWQgPSBwcmljZUNoYW5nZXMucmVkdWNlKChhY2N1bXVsYXRvciwgY3VycmVudFZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBhY2N1bXVsYXRvciArICgoY3VycmVudFZhbHVlID4gMSkgPyAxIDogMCk7XHJcbiAgICAgICAgfSwgMCk7XHJcbiAgICAgICAgcmV0dXJuIG51bWJlck9mVGltZXNQcmljZUluY3JlYXNlZCAvIHByaWNlQ2hhbmdlcy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3RvY2tQcmljZXMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyW10+KCk7XHJcbiAgICBjb25zdCBzdG9ja1ByaWNlQ2hhbmdlcyA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXJbXT4oKTtcclxuICAgIGxldCBzdG9ja1N5bWJvbHMgPSBucy5zdG9jay5nZXRTeW1ib2xzKCk7XHJcbiAgICAvLyBJbml0XHJcbiAgICBzdG9ja1N5bWJvbHMuZm9yRWFjaChzeW1ib2wgPT4ge1xyXG4gICAgICAgIHN0b2NrUHJpY2VzLnNldChzeW1ib2wsIFtucy5zdG9jay5nZXRQcmljZShzeW1ib2wpXSk7XHJcbiAgICAgICAgc3RvY2tQcmljZUNoYW5nZXMuc2V0KHN5bWJvbCwgW10pO1xyXG4gICAgfSk7XHJcbiAgICB3aGlsZSAodHJ1ZSkge1xyXG4gICAgICAgIGNvbnN0IG51bWJlck9mU2FtcGxlcyA9IDE1O1xyXG4gICAgICAgIC8vIENoZWNrIGlmIHN0b2NrIHByaWNlIGNoYW5nZWRcclxuICAgICAgICBjb25zdCBpc1ByaWNlQ2hhbmdlZCA9IHN0b2NrU3ltYm9scy5zb21lKHN5bWJvbCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHN5bWJvbFByaWNlcyA9IHN0b2NrUHJpY2VzLmdldChzeW1ib2wpITtcclxuICAgICAgICAgICAgcmV0dXJuIHN5bWJvbFByaWNlc1tzeW1ib2xQcmljZXMubGVuZ3RoIC0gMV0gIT09IG5zLnN0b2NrLmdldFByaWNlKHN5bWJvbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKCFpc1ByaWNlQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICBucy5jbGVhckxvZygpO1xyXG4gICAgICAgICAgICBwcmludFN0b2NrRGF0YShucyk7XHJcbiAgICAgICAgICAgIGF3YWl0IG5zLnNsZWVwKDEwMDApO1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBlbm91Z2ggc2FtcGxlc1xyXG4gICAgICAgIGNvbnN0IGhhdmVFbm91Z2hTYW1wbGVzID0gc3RvY2tTeW1ib2xzLmV2ZXJ5KChzeW1ib2wpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHN0b2NrUHJpY2VDaGFuZ2VzLmdldChzeW1ib2wpIS5sZW5ndGggPiBudW1iZXJPZlNhbXBsZXM7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gUmVjb3JkIG5ldyBwcmljZVxyXG4gICAgICAgIHN0b2NrU3ltYm9scy5mb3JFYWNoKHN5bWJvbCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHN5bWJvbFByaWNlcyA9IHN0b2NrUHJpY2VzLmdldChzeW1ib2wpITtcclxuICAgICAgICAgICAgY29uc3Qgc3ltYm9sUHJpY2VDaGFuZ2VzID0gc3RvY2tQcmljZUNoYW5nZXMuZ2V0KHN5bWJvbCkhO1xyXG4gICAgICAgICAgICBzeW1ib2xQcmljZXMucHVzaChucy5zdG9jay5nZXRQcmljZShzeW1ib2wpKTtcclxuICAgICAgICAgICAgaWYgKHN5bWJvbFByaWNlcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgICAgICBzeW1ib2xQcmljZUNoYW5nZXMucHVzaChzeW1ib2xQcmljZXNbc3ltYm9sUHJpY2VzLmxlbmd0aCAtIDFdIC8gc3ltYm9sUHJpY2VzW3N5bWJvbFByaWNlcy5sZW5ndGggLSAyXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGhhdmVFbm91Z2hTYW1wbGVzKSB7XHJcbiAgICAgICAgICAgICAgICBzeW1ib2xQcmljZXMuc2hpZnQoKTtcclxuICAgICAgICAgICAgICAgIHN5bWJvbFByaWNlQ2hhbmdlcy5zaGlmdCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gT25seSBwcm9jZWVkIGlmIHdlIGhhdmUgZW5vdWdoIHNhbXBsZXNcclxuICAgICAgICBpZiAoIWhhdmVFbm91Z2hTYW1wbGVzKSB7XHJcbiAgICAgICAgICAgIG5zLmNsZWFyTG9nKCk7XHJcbiAgICAgICAgICAgIHByaW50U3RvY2tEYXRhKG5zKTtcclxuICAgICAgICAgICAgYXdhaXQgbnMuc2xlZXAoMTAwMCk7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgc3RvY2tTeW1ib2xzID0gc3RvY2tTeW1ib2xzXHJcbiAgICAgICAgICAgIC5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5hYnMoMC41IC0gZ2V0Rm9yZWNhc3Qoc3RvY2tQcmljZUNoYW5nZXMuZ2V0KGIpISkpIC0gTWF0aC5hYnMoMC41IC0gZ2V0Rm9yZWNhc3Qoc3RvY2tQcmljZUNoYW5nZXMuZ2V0KGEpISkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICBmb3IgKGNvbnN0IHN0b2NrU3ltYm9sIG9mIHN0b2NrU3ltYm9scykge1xyXG4gICAgICAgICAgICBsZXQgYXZhaWxhYmxlTW9uZXkgPSBucy5nZXRQbGF5ZXIoKS5tb25leSAtIGNvbmZpZy5yZXNlcnZlZE1vbmV5O1xyXG4gICAgICAgICAgICBpZiAoYXZhaWxhYmxlTW9uZXkgPD0gMCkge1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBucy5zdG9jay5nZXRQb3NpdGlvbihzdG9ja1N5bWJvbCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNoYXJlc0xvbmcgPSBwb3NpdGlvblswXTtcclxuICAgICAgICAgICAgY29uc3Qgc2hhcmVzU2hvcnQgPSBwb3NpdGlvblsyXTtcclxuICAgICAgICAgICAgY29uc3QgZm9yZWNhc3QgPSBnZXRGb3JlY2FzdChzdG9ja1ByaWNlQ2hhbmdlcy5nZXQoc3RvY2tTeW1ib2wpISk7XHJcblxyXG4gICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSB3YW50IHRvIHNlbGwgbG9uZ1xyXG4gICAgICAgICAgICBpZiAoZm9yZWNhc3QgPCAwLjQgJiYgc2hhcmVzTG9uZyA+IDApIHtcclxuICAgICAgICAgICAgICAgIG5zLnN0b2NrLnNlbGxTdG9jayhzdG9ja1N5bWJvbCwgc2hhcmVzTG9uZyk7XHJcbiAgICAgICAgICAgICAgICBhdmFpbGFibGVNb25leSA9IG5zLmdldFBsYXllcigpLm1vbmV5IC0gY29uZmlnLnJlc2VydmVkTW9uZXk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2Ugd2FudCB0byBzZWxsIHNob3J0XHJcbiAgICAgICAgICAgIGlmIChmb3JlY2FzdCA+IDAuNSAmJiBzaGFyZXNTaG9ydCA+IDAgJiYgY29uZmlnLmVuYWJsZVNob3J0KSB7XHJcbiAgICAgICAgICAgICAgICBucy5zdG9jay5zZWxsU2hvcnQoc3RvY2tTeW1ib2wsIHNoYXJlc1Nob3J0KTtcclxuICAgICAgICAgICAgICAgIGF2YWlsYWJsZU1vbmV5ID0gbnMuZ2V0UGxheWVyKCkubW9uZXkgLSBjb25maWcucmVzZXJ2ZWRNb25leTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2Ugd2FudCB0byBidXkgbG9uZ1xyXG4gICAgICAgICAgICBpZiAoZm9yZWNhc3QgPiAwLjcpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1heFNoYXJlc0ZvckJ1eWluZyA9IG5zLnN0b2NrLmdldE1heFNoYXJlcyhzdG9ja1N5bWJvbCkgLSBzaGFyZXNMb25nO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXNrUHJpY2UgPSBucy5zdG9jay5nZXRBc2tQcmljZShzdG9ja1N5bWJvbCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhZmZvcmRhYmxlU2hhcmVzID0gTWF0aC5mbG9vcihcclxuICAgICAgICAgICAgICAgICAgICAoYXZhaWxhYmxlTW9uZXkgLSBTVE9DS19NQVJLRVRfQ09NTUlTU0lPTl9GRUUpIC8gYXNrUHJpY2VcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZXMgPSBNYXRoLm1pbihhZmZvcmRhYmxlU2hhcmVzLCBtYXhTaGFyZXNGb3JCdXlpbmcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNoYXJlcyA8PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBucy5zdG9jay5idXlTdG9jayhzdG9ja1N5bWJvbCwgc2hhcmVzKTtcclxuICAgICAgICAgICAgICAgIGF2YWlsYWJsZU1vbmV5ID0gbnMuZ2V0UGxheWVyKCkubW9uZXkgLSBjb25maWcucmVzZXJ2ZWRNb25leTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2Ugd2FudCB0byBidXkgc2hvcnRcclxuICAgICAgICAgICAgaWYgKGZvcmVjYXN0IDwgMC4zICYmIGNvbmZpZy5lbmFibGVTaG9ydCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbWF4U2hhcmVzRm9yQnV5aW5nID0gbnMuc3RvY2suZ2V0TWF4U2hhcmVzKHN0b2NrU3ltYm9sKSAtIHNoYXJlc1Nob3J0O1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYmlkUHJpY2UgPSBucy5zdG9jay5nZXRCaWRQcmljZShzdG9ja1N5bWJvbCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhZmZvcmRhYmxlU2hhcmVzID0gTWF0aC5mbG9vcihcclxuICAgICAgICAgICAgICAgICAgICAoYXZhaWxhYmxlTW9uZXkgLSBTVE9DS19NQVJLRVRfQ09NTUlTU0lPTl9GRUUpIC8gYmlkUHJpY2VcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZXMgPSBNYXRoLm1pbihhZmZvcmRhYmxlU2hhcmVzLCBtYXhTaGFyZXNGb3JCdXlpbmcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNoYXJlcyA8PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBucy5zdG9jay5idXlTaG9ydChzdG9ja1N5bWJvbCwgc2hhcmVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBucy5jbGVhckxvZygpO1xyXG4gICAgICAgIHByaW50U3RvY2tEYXRhKG5zKTtcclxuICAgICAgICBhd2FpdCBucy5zbGVlcCgxMDAwKTtcclxuICAgIH1cclxufVxyXG5cclxubGV0IG5zeDogTmV0c2NyaXB0RXh0ZW5zaW9uO1xyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1haW4obnM6IE5TKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBuc3ggPSBuZXcgTmV0c2NyaXB0RXh0ZW5zaW9uKG5zKTtcclxuICAgIG5zeC5raWxsUHJvY2Vzc2VzU3Bhd25Gcm9tU2FtZVNjcmlwdCgpO1xyXG5cclxuICAgIGNvbnN0IGNvbmZpZyA9IChjdXN0b21Db25maWcgIT09IG51bGwpID8gY3VzdG9tQ29uZmlnIDogZGVmYXVsdENvbmZpZztcclxuXHJcbiAgICBucy5kaXNhYmxlTG9nKFwiQUxMXCIpO1xyXG5cclxuICAgIGlmICghbnMuc3RvY2suaGFzV1NFQWNjb3VudCgpKSB7XHJcbiAgICAgICAgbnMudHByaW50KFwiUGxlYXNlIGJ1eSBXU0UgYWNjb3VudFwiKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoIW5zLnN0b2NrLmhhc1RJWEFQSUFjY2VzcygpKSB7XHJcbiAgICAgICAgbnMudHByaW50KFwiUGxlYXNlIGJ1eSBUSVggQVBJIGFjY2Vzc1wiKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyBucy50YWlsKCk7XHJcbiAgICAvLyBucy5yZXNpemVUYWlsKDMzMCwgMTEwKTtcclxuICAgIC8vIG5zLm1vdmVUYWlsKDIwMDAsIDApO1xyXG5cclxuICAgIGlmIChucy5zdG9jay5oYXM0U0RhdGFUSVhBUEkoKSkge1xyXG4gICAgICAgIGF3YWl0IHRyYWRlU3RvY2tzV2l0aFM0TWFya2V0RGF0YShucywgY29uZmlnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXdhaXQgdHJhZGVTdG9ja3NXaXRob3V0UzRNYXJrZXREYXRhKG5zLCBjb25maWcpO1xyXG4gICAgfVxyXG59XHJcbiJdLAogICJtYXBwaW5ncyI6ICJBQUNBLFNBQVEsbUNBQWtDO0FBQzFDLFNBQVEsMEJBQXlCO0FBV2pDLE1BQU0sZ0JBQXdCO0FBQUEsRUFDMUIsZUFBZTtBQUFBLEVBQ2Ysa0JBQWtCO0FBQUEsRUFDbEIsbUJBQW1CO0FBQUEsRUFDbkIsbUJBQW1CO0FBQUEsRUFDbkIsb0JBQW9CO0FBQUEsRUFDcEIsYUFBYTtBQUNqQjtBQUVBLElBQUksZUFBOEI7QUFDbEMsZUFBdUI7QUFBQSxFQUNuQixlQUFlO0FBQUEsRUFDZixrQkFBa0I7QUFBQSxFQUNsQixtQkFBbUI7QUFBQSxFQUNuQixtQkFBbUIsY0FBYztBQUFBLEVBQ2pDLG9CQUFvQixjQUFjO0FBQUEsRUFDbEMsYUFBYTtBQUNqQjtBQUVBLFNBQVMsZUFBZSxJQUFRO0FBQzVCLFFBQU0sYUFBYSxJQUFJLG9CQUFvQjtBQUMzQyxLQUFHLE1BQU0sbUJBQW1CLEdBQUcsYUFBYSxXQUFXLGFBQWEsQ0FBQyxFQUFFO0FBQ3ZFLEtBQUcsTUFBTSwyQkFBMkIsR0FBRyxhQUFhLFdBQVcsb0JBQW9CLENBQUMsRUFBRTtBQUN0RixLQUFHLE1BQU0sa0JBQWtCLEdBQUcsYUFBYSxXQUFXLFlBQVksQ0FBQyxFQUFFO0FBQ3pFO0FBRUEsZUFBZSw0QkFBNEIsSUFBUSxRQUFnQjtBQUMvRCxTQUFPLE1BQU07QUFDVCxVQUFNLGVBQWUsR0FBRyxNQUFNLFdBQVcsRUFDcEMsS0FBSyxTQUFVLEdBQUcsR0FBRztBQUNsQixhQUFPLEtBQUssSUFBSSxNQUFNLEdBQUcsTUFBTSxZQUFZLENBQUMsQ0FBQyxJQUFJ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
