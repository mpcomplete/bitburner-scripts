import { assertIsNumber } from "/libs/utils";
import { DEFAULT_EXP_FARM_TARGETS, GROW_SCRIPT_NAME, LOG_FOLDER, WEAKEN_SCRIPT_NAME } from "/libs/constants";
import { NetscriptExtension } from "/libs/NetscriptExtension";
function autocomplete(data, flags) {
  return [...data.servers];
}
const defaultConfig = {
  influenceStock: false
};
let customConfig = null;
customConfig = {
  // influenceStock: false,
  influenceStock: true
};
let nsx;
async function main(ns) {
  nsx = new NetscriptExtension(ns);
  nsx.killProcessesSpawnFromSameScript();
  const config = customConfig !== null ? customConfig : defaultConfig;
  ns.disableLog("ALL");
  const farmingThreads = ns.args[0];
  assertIsNumber(farmingThreads);
  let targets = [];
  if (ns.args.length > 1) {
    for (let i = 1; i < ns.args.length; i++) {
      targets.push(ns.args[i]);
    }
  } else {
    targets = DEFAULT_EXP_FARM_TARGETS;
  }
  for (const target of targets) {
    while (true) {
      const growThreads = Math.ceil(
        ns.growthAnalyze(target, ns.getServerMaxMoney(target) / ns.getServerMoneyAvailable(target))
      );
      const growTime = ns.getGrowTime(target);
      if (growThreads > 0) {
        nsx.runScriptOnAvailablePrivateRunners(
          true,
          true,
          true,
          GROW_SCRIPT_NAME,
          growThreads,
          target,
          0
        );
        await ns.sleep(growTime + 1e3);
      }
      const securityReducedPerWeakenThead = ns.weakenAnalyze(1);
      const weakenThreads = Math.ceil(
        (ns.getServerSecurityLevel(target) - ns.getServerMinSecurityLevel(target)) / securityReducedPerWeakenThead
      );
      if (weakenThreads > 0) {
        const weakenTime = ns.getWeakenTime(target);
        nsx.runScriptOnAvailablePrivateRunners(
          true,
          true,
          true,
          WEAKEN_SCRIPT_NAME,
          weakenThreads,
          target,
          0
        );
        await ns.sleep(weakenTime + 1e3);
      }
      if (ns.getServerMoneyAvailable(target) === ns.getServerMaxMoney(target) && ns.getServerSecurityLevel(target) === ns.getServerMinSecurityLevel(target)) {
        break;
      }
    }
  }
  while (true) {
    const farmingThreadsPerTarget = Math.floor(farmingThreads / targets.length);
    const identifierPrefix = "expFarm-";
    for (const target of targets) {
      const logFilename = `${LOG_FOLDER}/${identifierPrefix}${target}.txt`;
      if (nsx.checkRunningProcesses(logFilename).stillHaveRunningProcess) {
        continue;
      }
      const result = nsx.runScriptOnAvailablePrivateRunners(
        true,
        true,
        false,
        GROW_SCRIPT_NAME,
        farmingThreadsPerTarget,
        target,
        0,
        config.influenceStock,
        `${identifierPrefix}${target}-${farmingThreadsPerTarget}`
        // Identifier
      );
      if (!result.success) {
        ns.tprint(`Fail to start all required threads. Target: ${target}. Threads: ${farmingThreadsPerTarget}`);
      }
      ns.write(logFilename, JSON.stringify(result.runnerProcesses), "w");
    }
    await ns.sleep(1e3);
  }
}
export {
  autocomplete,
  main
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vc3JjL2V4cEZhcm0udHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbImltcG9ydCB7QXV0b2NvbXBsZXRlRGF0YSwgTlN9IGZyb20gXCJAbnNcIjtcclxuaW1wb3J0IHthc3NlcnRJc051bWJlcn0gZnJvbSBcIi9saWJzL3V0aWxzXCI7XHJcbmltcG9ydCB7REVGQVVMVF9FWFBfRkFSTV9UQVJHRVRTLCBHUk9XX1NDUklQVF9OQU1FLCBMT0dfRk9MREVSLCBXRUFLRU5fU0NSSVBUX05BTUV9IGZyb20gXCIvbGlicy9jb25zdGFudHNcIjtcclxuaW1wb3J0IHtOZXRzY3JpcHRFeHRlbnNpb259IGZyb20gXCIvbGlicy9OZXRzY3JpcHRFeHRlbnNpb25cIjtcclxuXHJcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnNcclxuZXhwb3J0IGZ1bmN0aW9uIGF1dG9jb21wbGV0ZShkYXRhOiBBdXRvY29tcGxldGVEYXRhLCBmbGFnczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICByZXR1cm4gWy4uLmRhdGEuc2VydmVyc107XHJcbn1cclxuXHJcbmludGVyZmFjZSBDb25maWcge1xyXG4gICAgaW5mbHVlbmNlU3RvY2s6IGJvb2xlYW47XHJcbn1cclxuXHJcbmNvbnN0IGRlZmF1bHRDb25maWc6IENvbmZpZyA9IHtcclxuICAgIGluZmx1ZW5jZVN0b2NrOiBmYWxzZVxyXG59O1xyXG5cclxubGV0IGN1c3RvbUNvbmZpZzogQ29uZmlnIHwgbnVsbCA9IG51bGw7XHJcbmN1c3RvbUNvbmZpZyA9IDxDb25maWc+e1xyXG4gICAgLy8gaW5mbHVlbmNlU3RvY2s6IGZhbHNlLFxyXG4gICAgaW5mbHVlbmNlU3RvY2s6IHRydWUsXHJcbn07XHJcblxyXG5sZXQgbnN4OiBOZXRzY3JpcHRFeHRlbnNpb247XHJcblxyXG4vKipcclxuICogVXNhZ2U6IHJ1biBleHBGYXJtLmpzIDEwMDAgam9lc2d1bnNcclxuICogQHBhcmFtIG5zXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbWFpbihuczogTlMpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIG5zeCA9IG5ldyBOZXRzY3JpcHRFeHRlbnNpb24obnMpO1xyXG4gICAgbnN4LmtpbGxQcm9jZXNzZXNTcGF3bkZyb21TYW1lU2NyaXB0KCk7XHJcblxyXG4gICAgY29uc3QgY29uZmlnID0gKGN1c3RvbUNvbmZpZyAhPT0gbnVsbCkgPyBjdXN0b21Db25maWcgOiBkZWZhdWx0Q29uZmlnO1xyXG5cclxuICAgIG5zLmRpc2FibGVMb2coXCJBTExcIik7XHJcblxyXG4gICAgY29uc3QgZmFybWluZ1RocmVhZHMgPSBucy5hcmdzWzBdO1xyXG4gICAgYXNzZXJ0SXNOdW1iZXIoZmFybWluZ1RocmVhZHMpO1xyXG5cclxuICAgIGxldCB0YXJnZXRzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgaWYgKG5zLmFyZ3MubGVuZ3RoID4gMSkge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbnMuYXJncy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICB0YXJnZXRzLnB1c2goPHN0cmluZz5ucy5hcmdzW2ldKTtcclxuICAgICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRhcmdldHMgPSBERUZBVUxUX0VYUF9GQVJNX1RBUkdFVFM7XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChjb25zdCB0YXJnZXQgb2YgdGFyZ2V0cykge1xyXG4gICAgICAgIC8vIFByZXBhcmUgdGFyZ2V0czogZ3JvdyB0byBtYXgsIHdlYWtlbiB0byBtaW5cclxuICAgICAgICB3aGlsZSAodHJ1ZSkge1xyXG4gICAgICAgICAgICAvLyBHcm93IHRvIG1heCBtb25leVxyXG4gICAgICAgICAgICBjb25zdCBncm93VGhyZWFkcyA9IE1hdGguY2VpbChcclxuICAgICAgICAgICAgICAgIG5zLmdyb3d0aEFuYWx5emUodGFyZ2V0LCBucy5nZXRTZXJ2ZXJNYXhNb25leSh0YXJnZXQpIC8gbnMuZ2V0U2VydmVyTW9uZXlBdmFpbGFibGUodGFyZ2V0KSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgY29uc3QgZ3Jvd1RpbWUgPSBucy5nZXRHcm93VGltZSh0YXJnZXQpO1xyXG4gICAgICAgICAgICBpZiAoZ3Jvd1RocmVhZHMgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBuc3gucnVuU2NyaXB0T25BdmFpbGFibGVQcml2YXRlUnVubmVycyhcclxuICAgICAgICAgICAgICAgICAgICB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICBHUk9XX1NDUklQVF9OQU1FLFxyXG4gICAgICAgICAgICAgICAgICAgIGdyb3dUaHJlYWRzLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldCxcclxuICAgICAgICAgICAgICAgICAgICAwXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgbnMuc2xlZXAoZ3Jvd1RpbWUgKyAxMDAwKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gUmVkdWNlIHNlY3VyaXR5IHRvIG1pbiB2YWx1ZVxyXG4gICAgICAgICAgICBjb25zdCBzZWN1cml0eVJlZHVjZWRQZXJXZWFrZW5UaGVhZCA9IG5zLndlYWtlbkFuYWx5emUoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHdlYWtlblRocmVhZHMgPSBNYXRoLmNlaWwoXHJcbiAgICAgICAgICAgICAgICAobnMuZ2V0U2VydmVyU2VjdXJpdHlMZXZlbCh0YXJnZXQpIC0gbnMuZ2V0U2VydmVyTWluU2VjdXJpdHlMZXZlbCh0YXJnZXQpKSAvIHNlY3VyaXR5UmVkdWNlZFBlcldlYWtlblRoZWFkXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGlmICh3ZWFrZW5UaHJlYWRzID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgd2Vha2VuVGltZSA9IG5zLmdldFdlYWtlblRpbWUodGFyZ2V0KTtcclxuICAgICAgICAgICAgICAgIG5zeC5ydW5TY3JpcHRPbkF2YWlsYWJsZVByaXZhdGVSdW5uZXJzKFxyXG4gICAgICAgICAgICAgICAgICAgIHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIFdFQUtFTl9TQ1JJUFRfTkFNRSxcclxuICAgICAgICAgICAgICAgICAgICB3ZWFrZW5UaHJlYWRzLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldCxcclxuICAgICAgICAgICAgICAgICAgICAwXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgbnMuc2xlZXAod2Vha2VuVGltZSArIDEwMDApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBDaGVjayBpZiBzZXJ2ZXIgaGFzIGJlZW4gcHJlcGFyZWQgc3VjY2Vzc2Z1bGx5XHJcbiAgICAgICAgICAgIGlmIChucy5nZXRTZXJ2ZXJNb25leUF2YWlsYWJsZSh0YXJnZXQpID09PSBucy5nZXRTZXJ2ZXJNYXhNb25leSh0YXJnZXQpXHJcbiAgICAgICAgICAgICAgICAmJiBucy5nZXRTZXJ2ZXJTZWN1cml0eUxldmVsKHRhcmdldCkgPT09IG5zLmdldFNlcnZlck1pblNlY3VyaXR5TGV2ZWwodGFyZ2V0KSkge1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ29udGludW91c2x5IHJ1biBncm93IHNjcmlwdCB0byBmYXJtIGV4cFxyXG4gICAgd2hpbGUgKHRydWUpIHtcclxuICAgICAgICBjb25zdCBmYXJtaW5nVGhyZWFkc1BlclRhcmdldCA9IE1hdGguZmxvb3IoZmFybWluZ1RocmVhZHMgLyB0YXJnZXRzLmxlbmd0aCk7XHJcbiAgICAgICAgY29uc3QgaWRlbnRpZmllclByZWZpeCA9IFwiZXhwRmFybS1cIjtcclxuICAgICAgICBmb3IgKGNvbnN0IHRhcmdldCBvZiB0YXJnZXRzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxvZ0ZpbGVuYW1lID0gYCR7TE9HX0ZPTERFUn0vJHtpZGVudGlmaWVyUHJlZml4fSR7dGFyZ2V0fS50eHRgO1xyXG4gICAgICAgICAgICBpZiAobnN4LmNoZWNrUnVubmluZ1Byb2Nlc3Nlcyhsb2dGaWxlbmFtZSkuc3RpbGxIYXZlUnVubmluZ1Byb2Nlc3MpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG5zeC5ydW5TY3JpcHRPbkF2YWlsYWJsZVByaXZhdGVSdW5uZXJzKFxyXG4gICAgICAgICAgICAgICAgdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHRydWUsXHJcbiAgICAgICAgICAgICAgICBmYWxzZSxcclxuICAgICAgICAgICAgICAgIEdST1dfU0NSSVBUX05BTUUsXHJcbiAgICAgICAgICAgICAgICBmYXJtaW5nVGhyZWFkc1BlclRhcmdldCxcclxuICAgICAgICAgICAgICAgIHRhcmdldCxcclxuICAgICAgICAgICAgICAgIDAsXHJcbiAgICAgICAgICAgICAgICBjb25maWcuaW5mbHVlbmNlU3RvY2ssXHJcbiAgICAgICAgICAgICAgICBgJHtpZGVudGlmaWVyUHJlZml4fSR7dGFyZ2V0fS0ke2Zhcm1pbmdUaHJlYWRzUGVyVGFyZ2V0fWAgLy8gSWRlbnRpZmllclxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XHJcbiAgICAgICAgICAgICAgICBucy50cHJpbnQoYEZhaWwgdG8gc3RhcnQgYWxsIHJlcXVpcmVkIHRocmVhZHMuIFRhcmdldDogJHt0YXJnZXR9LiBUaHJlYWRzOiAke2Zhcm1pbmdUaHJlYWRzUGVyVGFyZ2V0fWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG5zLndyaXRlKGxvZ0ZpbGVuYW1lLCBKU09OLnN0cmluZ2lmeShyZXN1bHQucnVubmVyUHJvY2Vzc2VzKSwgXCJ3XCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhd2FpdCBucy5zbGVlcCgxMDAwKTtcclxuICAgIH1cclxufVxyXG4iXSwKICAibWFwcGluZ3MiOiAiQUFDQSxTQUFRLHNCQUFxQjtBQUM3QixTQUFRLDBCQUEwQixrQkFBa0IsWUFBWSwwQkFBeUI7QUFDekYsU0FBUSwwQkFBeUI7QUFHMUIsU0FBUyxhQUFhLE1BQXdCLE9BQTJCO0FBQzVFLFNBQU8sQ0FBQyxHQUFHLEtBQUssT0FBTztBQUMzQjtBQU1BLE1BQU0sZ0JBQXdCO0FBQUEsRUFDMUIsZ0JBQWdCO0FBQ3BCO0FBRUEsSUFBSSxlQUE4QjtBQUNsQyxlQUF1QjtBQUFBO0FBQUEsRUFFbkIsZ0JBQWdCO0FBQ3BCO0FBRUEsSUFBSTtBQU1KLGVBQXNCLEtBQUssSUFBdUI7QUFDOUMsUUFBTSxJQUFJLG1CQUFtQixFQUFFO0FBQy9CLE1BQUksaUNBQWlDO0FBRXJDLFFBQU0sU0FBVSxpQkFBaUIsT0FBUSxlQUFlO0FBRXhELEtBQUcsV0FBVyxLQUFLO0FBRW5CLFFBQU0saUJBQWlCLEdBQUcsS0FBSyxDQUFDO0FBQ2hDLGlCQUFlLGNBQWM7QUFFN0IsTUFBSSxVQUFvQixDQUFDO0FBQ3pCLE1BQUksR0FBRyxLQUFLLFNBQVMsR0FBRztBQUNwQixhQUFTLElBQUksR0FBRyxJQUFJLEdBQUcsS0FBSyxRQUFRLEtBQUs7QUFDckMsY0FBUSxLQUFhLEdBQUcsS0FBSyxDQUFDLENBQUM7QUFBQSxJQUNuQztBQUFBLEVBQ0osT0FBTztBQUNILGNBQVU7QUFBQSxFQUNkO0FBRUEsYUFBVyxVQUFVLFNBQVM7QUFFMUIsV0FBTyxNQUFNO0FBRVQsWUFBTSxjQUFjLEtBQUs7QUFBQSxRQUNyQixHQUFHLGNBQWMsUUFBUSxHQUFHLGtCQUFrQixNQUFNLElBQUksR0FBRyx3QkFBd0IsTUFBTSxDQUFDO0FBQUEsTUFDOUY7QUFDQSxZQUFNLFdBQVcsR0FBRyxZQUFZLE1BQU07QUFDdEMsVUFBSSxjQUFjLEdBQUc7QUFDakIsWUFBSTtBQUFBLFVBQ0E7QUFBQSxVQUNBO0FBQUEsVUFDQTtBQUFBLFVBQ0E7QUFBQSxVQUNBO0FBQUEsVUFDQTtBQUFBLFVBQ0E7QUFBQSxRQUNKO0FBQ0EsY0FBTSxHQUFHLE1BQU0sV0FBVyxHQUFJO0FBQUEsTUFDbEM7QUFHQSxZQUFNLGdDQUFnQyxHQUFHLGNBQWMsQ0FBQztBQUN4RCxZQUFNLGdCQUFnQixLQUFLO0FBQUEsU0FDdEIsR0FBRyx1QkFBdUIsTUFBTSxJQUFJLEdBQUcsMEJBQTBCLE1BQU0sS0FBSztBQUFBLE1BQ2pGO0FBQ0EsVUFBSSxnQkFBZ0IsR0FBRztBQUNuQixjQUFNLGFBQWEsR0FBRyxjQUFjLE1BQU07QUFDMUMsWUFBSTtBQUFBLFVBQ0E7QUFBQSxVQUNBO0FBQUEsVUFDQTtBQUFBLFVBQ0E7QUFBQSxVQUNBO0FBQUEsVUFDQTtBQUFBLFVBQ0E7QUFBQSxRQUNKO0FBQ0EsY0FBTSxHQUFHLE1BQU0sYUFBYSxHQUFJO0FBQUEsTUFDcEM7QUFHQSxVQUFJLEdBQUcsd0JBQXdCLE1BQU0sTUFBTSxHQUFHLGtCQUFrQixNQUFNLEtBQy9ELEdBQUcsdUJBQXVCLE1BQU0sTUFBTSxHQUFHLDBCQUEwQixNQUFNLEdBQUc7QUFDL0U7QUFBQSxNQUNKO0FBQUEsSUFDSjtBQUFBLEVBQ0o7QUFHQSxTQUFPLE1BQU07QUFDVCxVQUFNLDBCQUEwQixLQUFLLE1BQU0saUJBQWlCLFFBQVEsTUFBTTtBQUMxRSxVQUFNLG1CQUFtQjtBQUN6QixlQUFXLFVBQVUsU0FBUztBQUMxQixZQUFNLGNBQWMsR0FBRyxVQUFVLElBQUksZ0JBQWdCLEdBQUcsTUFBTTtBQUM5RCxVQUFJLElBQUksc0JBQXNCLFdBQVcsRUFBRSx5QkFBeUI7QUFDaEU7QUFBQSxNQUNKO0FBQ0EsWUFBTSxTQUFTLElBQUk7QUFBQSxRQUNmO0FBQUEsUUFDQTtBQUFBLFFBQ0E7QUFBQSxRQUNBO0FBQUEsUUFDQTtBQUFBLFFBQ0E7QUFBQSxRQUNBO0FBQUEsUUFDQSxPQUFPO0FBQUEsUUFDUCxHQUFHLGdCQUFnQixHQUFHLE1BQU0sSUFBSSx1QkFBdUI7QUFBQTtBQUFBLE1BQzNEO0FBQ0EsVUFBSSxDQUFDLE9BQU8sU0FBUztBQUNqQixXQUFHLE9BQU8sK0NBQStDLE1BQU0sY0FBYyx1QkFBdUIsRUFBRTtBQUFBLE1BQzFHO0FBQ0EsU0FBRyxNQUFNLGFBQWEsS0FBSyxVQUFVLE9BQU8sZUFBZSxHQUFHLEdBQUc7QUFBQSxJQUNyRTtBQUNBLFVBQU0sR0FBRyxNQUFNLEdBQUk7QUFBQSxFQUN2QjtBQUNKOyIsCiAgIm5hbWVzIjogW10KfQo=
